# Инструкция по проверке деплоя на сервере

## Цель проверки
Убедиться, что:
1. Код обновлен до последней версии
2. Бот работает корректно
3. Цвета категорий применяются правильно
4. Команда `/map` без аргументов не читает файл

## Шаг 1: Проверка версии кода

```bash
# Перейти в директорию проекта
cd /path/to/ump_bot

# Проверить последний коммит
git log -1 --oneline

# Проверить, нет ли незакоммиченных изменений
git status

# Если есть изменения - показать diff
git diff HEAD
```

**Ожидаемый результат:** Последний коммит должен содержать изменения в `src/ump_bot/telegram_bot.py` и `src/ump_bot/render_map.py` с добавлением логирования для `color_map`.

## Шаг 2: Проверка структуры файлов

```bash
# Проверить наличие ключевых файлов
ls -la src/ump_bot/telegram_bot.py src/ump_bot/render_map.py

# Проверить, что функции логирования присутствуют
grep -n "color_map создан" src/ump_bot/telegram_bot.py
grep -n "build_color_map_from_sections" src/ump_bot/telegram_bot.py
grep -n "\[DEBUG\] color_map передан" src/ump_bot/render_map.py
```

**Ожидаемый результат:** Все три команды должны найти соответствующие строки в файлах.

## Шаг 3: Проверка запущенного процесса

```bash
# Если используется Docker
docker-compose ps
docker-compose logs --tail=50 ump-bot

# Если используется systemd
systemctl status ump-bot
journalctl -u ump-bot -n 50 --no-pager
```

**Ожидаемый результат:** 
- Процесс должен быть в статусе `running` (Docker) или `active (running)` (systemd)
- В логах не должно быть критических ошибок

## Шаг 4: Проверка логики `/map` без аргументов

**Действие:** Отправить в Telegram боту команду `/map` без аргументов.

**Ожидаемый результат:**
```
❌ Укажите номера ТС. Пример: /map 6683 6719 6306

Или просто отправьте текст с задачами (без команды /map)
```

**Если результат другой (например, показывает карту с ТС):**
- Код не обновлен на сервере
- Нужно перезапустить бота после обновления

## Шаг 5: Проверка парсинга текста и цветов

**Действие:** Отправить в Telegram боту следующий текст (без команды):

```
Заявки Redmine:
6510
6241

Текущие задачи:
6719
6684

Проверка ГК, маршрут 54:
6700
10123
```

**Проверка логов:**

```bash
# Docker
docker-compose logs -f ump-bot | grep -E "(color_map|Категории|DEBUG)"

# systemd
journalctl -u ump-bot -f | grep -E "(color_map|Категории|DEBUG)"
```

**Ожидаемые сообщения в логах:**

1. Парсинг текста:
```
Парсинг текста: найдено 6 ТС из 3 категорий
Категории: ['Заявки Redmine', 'Текущие задачи', 'Проверка ГК, маршрут 54']
  Заявки Redmine: ['6510', '6241']
  Текущие задачи: ['6719', '6684']
  Проверка ГК, маршрут 54: ['6700', '10123']
```

2. Создание color_map:
```
build_color_map_from_sections: обрабатываю 3 категорий
  Категория 'Заявки Redmine': цвет #4dabf7, ТС: ['6510', '6241']
  Категория 'Текущие задачи': цвет #ff922b, ТС: ['6719', '6684']
  Категория 'Проверка ГК, маршрут 54': цвет #ffd43b, ТС: ['6700', '10123']
build_color_map_from_sections: создано 6 записей в color_map
color_map создан: 6 ТС с цветами
Примеры цветов: [('6510', ('#4dabf7', '#339af0')), ('6241', ('#4dabf7', '#339af0')), ('6719', ('#ff922b', '#fd7e14'))]
```

3. Передача в render:
```
[DEBUG] color_map передан: 6 ТС
[DEBUG]   6510 -> ('#4dabf7', '#339af0')
[DEBUG]   6241 -> ('#4dabf7', '#339af0')
[DEBUG]   6719 -> ('#ff922b', '#fd7e14')
```

4. Применение цветов к точкам:
```
[DEBUG] ТС 6510: цвет #4dabf7 (из color_map)
[DEBUG] ТС 6241: цвет #4dabf7 (из color_map)
[DEBUG] ТС 6719: цвет #ff922b (из color_map)
[DEBUG] ТС 6684: цвет #ff922b (из color_map)
[DEBUG] ТС 6700: цвет #ffd43b (из color_map)
[DEBUG] ТС 10123: цвет #ffd43b (из color_map)
```

**Если этих сообщений нет:**
- Код не обновлен
- Или логирование не работает (проверить настройки логирования)

## Шаг 6: Визуальная проверка карты

**Ожидаемый результат на карте:**
- ТС 6510, 6241 - **синие** точки (Заявки Redmine)
- ТС 6719, 6684 - **оранжевые** точки (Текущие задачи)
- ТС 6700, 10123 - **желтые** точки (Проверка ГК)

**Если все точки красные:**
- `color_map` не создается или не передается
- Проверить логи на наличие ошибок
- Убедиться, что код обновлен

## Шаг 7: Проверка команды `/map` с аргументами

**Действие:** Отправить `/map 6510 6719 6700`

**Ожидаемый результат:**
- Карта с 3 ТС
- Все точки **красные** (так как нет категорий для явных номеров)
- В логах: `Номера из аргументов: ['6510', '6719', '6700']`

## Шаг 8: Проверка обработки ошибок

**Действие:** Отправить текст без номеров ТС:
```
Заявки Redmine:

Текущие задачи:
```

**Ожидаемый результат:**
```
❌ Не найдено номеров ТС в сообщении.
```

## Чеклист проверки

- [ ] Код обновлен до последней версии (git log показывает последний коммит)
- [ ] Бот запущен и работает (status = running/active)
- [ ] `/map` без аргументов выдает ошибку (не читает файл)
- [ ] Текст с категориями парсится правильно (логи показывают категории)
- [ ] `color_map` создается (логи показывают "color_map создан: X ТС")
- [ ] `color_map` передается в render (логи показывают "[DEBUG] color_map передан")
- [ ] Цвета применяются к точкам (логи показывают "ТС X: цвет #XXXXXX")
- [ ] На карте точки разных цветов (визуальная проверка)

## Если что-то не работает

1. **Проверить версию кода:**
   ```bash
   git log -1 --oneline
   git diff HEAD~1 src/ump_bot/telegram_bot.py | head -50
   ```

2. **Перезапустить бота:**
   ```bash
   # Docker
   docker-compose restart ump-bot
   
   # systemd
   sudo systemctl restart ump-bot
   ```

3. **Проверить логи на ошибки:**
   ```bash
   docker-compose logs ump-bot | grep -i error
   # или
   journalctl -u ump-bot | grep -i error
   ```

4. **Проверить переменные окружения:**
   ```bash
   docker-compose exec ump-bot env | grep -E "(UMP|MAP|TELEGRAM)"
   ```

## Команды для быстрой проверки

```bash
# Полная проверка одной командой
cd /path/to/ump_bot && \
echo "=== Версия кода ===" && \
git log -1 --oneline && \
echo "" && \
echo "=== Проверка функций ===" && \
grep -c "color_map создан" src/ump_bot/telegram_bot.py && \
grep -c "\[DEBUG\] color_map передан" render_map.py && \
echo "" && \
echo "=== Статус бота ===" && \
docker-compose ps ump-bot 2>/dev/null || systemctl is-active ump-bot && \
echo "" && \
echo "=== Последние логи ===" && \
docker-compose logs --tail=20 ump-bot 2>/dev/null || journalctl -u ump-bot -n 20 --no-pager
```

